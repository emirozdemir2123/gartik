<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gartic Klonu (Modern)</title>
    <style>
        /* Modern CSS Reset ve Temel Stiller */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 20px;
            color: #333;
        }
        h1 { color: #007bff; margin-bottom: 25px; }
        
        /* Kart Stili (Modern görünümün temeli) */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        /* Form ve Buton Stilleri */
        input[type="text"], input[type="color"], input[type="range"], button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 1em;
            transition: all 0.2s;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .input-group label { font-weight: 600; display: block; margin-bottom: 5px; color: #555; }

        /* --- LOBİ STİLİ --- */
        #lobby-view { width: 900px; max-width: 95%; }
        
        #room-list {
            list-style: none; 
            padding: 0; 
            margin-top: 20px;
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; 
        }
        .room-item { 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            align-items: flex-start; 
            min-height: 120px; 
            padding: 15px; 
            background: linear-gradient(135deg, #eaf4ff, #ffffff); 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); 
            border: 1px solid #cceeff; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .room-item:hover {
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); 
            transform: translateY(-2px); 
        }
        .room-info strong { 
            font-size: 1.3em; 
            color: #007bff; 
            margin-bottom: 5px;
            display: block;
        }
        .room-status { 
            font-size: 0.85em; 
            color: #6c757d; 
            margin-bottom: 10px;
        }
        .room-item button {
            width: 100%; 
            margin-top: auto; 
            padding: 8px;
            font-size: 0.9em;
        }
        .room-item button[disabled] {
            background-color: #dc3545 !important;
        }
        
        #create-room-form { display: flex; gap: 10px; margin-top: 20px; }

        /* --- OYUN STİLİ --- */
        #game-view { display: none; width: 950px; max-width: 95%; }

        #game-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            width: 100%;
        }
        #game-info { display: flex; gap: 30px; align-items: center;}
        #word-info-drawer { color: #dc3545; font-weight: 600; margin-left: 10px; display: none; } 
        #timer { font-size: 1.8em; font-weight: bold; color: #dc3545; background: #fff; padding: 5px 15px; border-radius: 8px; border: 2px solid #dc3545; }

        #game-area-container { display: flex; gap: 20px; }
        
        /* Çizim Alanı ve Kontroller */
        #drawing-card { flex-grow: 1; max-width: 650px; padding: 15px; }
        #game-container { border: 1px solid #e0e0e0; background-color: #fff; cursor: crosshair; border-radius: 8px; }
        
        #controls { 
            display: none; 
            padding: 15px 0 5px 0; 
            gap: 15px; 
            justify-content: center; 
            align-items: center; 
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        #controls label { font-size: 0.9em; }

        /* Sohbet ve Puan Tablosu Alanı (Sağ Blok) */
        #right-sidebar { width: 300px; display: flex; flex-direction: column; gap: 20px; }
        
        #leaderboard-card { padding: 15px; height: auto;}
        #leaderboard-card h4 { margin-top: 0; margin-bottom: 10px; color: #007bff; }
        #leaderboard-list { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        .leaderboard-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #eee; }
        .leaderboard-item:last-child { border-bottom: none; }
        .leaderboard-item strong { color: #28a745; }

        #chat-card { padding: 0; display: flex; flex-direction: column; flex-grow: 1;}
        #chat-card h3 { padding: 15px 25px; margin: 0; border-bottom: 1px solid #eee; font-size: 1.1em; }
        #messages { 
            list-style: none; padding: 15px; margin: 0; overflow-y: auto; 
            flex-grow: 1; height: 250px; max-height: 250px; 
            font-size: 0.95em;
        }
        .system-message { color: #6c757d; font-style: italic; }
        .chat-form-container { display: flex; padding: 10px; border-top: 1px solid #e0e0e0; }
        .chat-form-container input { border: none; border-radius: 0; }
        .chat-form-container button { border-radius: 0 6px 6px 0; background-color: #28a745; }
    </style>
</head>
<body>

    <h1>✏️ Gartic Klonu</h1>

    <div id="lobby-view" class="card">
        <h2>Oyun Odaları <small style="color:#888;">(Max 10 Oyuncu)</small></h2>
        
        <div class="input-group">
            <label for="nickname-input">Kullanıcı Adınız:</label>
            <input type="text" id="nickname-input" value="Oyuncu" maxlength="15" style="width: 97%;">
        </div>

        <ul id="room-list">
            <li style="text-align: center; color: #6c757d; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 5px;">Sunucular yükleniyor...</li>
        </ul>
        
        <div id="create-room-form">
            <input type="text" id="new-room-input" placeholder="Yeni Oda Adı (Örn: sw3)">
            <button id="create-room-button">Oluştur ve Katıl</button>
        </div>
    </div>

    <div id="game-view">
        
        <div id="game-header" class="card">
            <span id="timer">60</span>
            <div id="game-info">
                <p>Çizen: <strong id="drawer-info">Bekleniyor...</strong></p>
                <p>Kelime: <strong id="word-info">_ _ _ _ _</strong> <span id="word-info-drawer"></span></p>
            </div>
        </div>

        <div id="game-area-container">
            
            <div id="drawing-card" class="card">
                <h3 style="margin-top: 0;">Çizim Alanı</h3>
                <canvas id="game-container" width="600" height="400"></canvas>
                
                <div id="controls">
                    <label for="color-picker">Renk:</label>
                    <input type="color" id="color-picker" value="#000000" style="width: 60px; height: 30px; padding: 0;">
                    
                    <label for="brush-size">Kalınlık:</label>
                    <input type="range" id="brush-size" min="1" max="20" value="5" style="width: 100px;">
                    
                    <button onclick="requestClearCanvas()" style="background-color: #dc3545;">Tuvali Temizle</button>
                </div>
            </div>

            <div id="right-sidebar">
                
                <div id="leaderboard-card" class="card">
                    <h4>Puan Tablosu</h4>
                    <ul id="leaderboard-list">
                        <li style="color: #6c757d;">Oyuncular bekleniyor...</li>
                    </ul>
                </div>

                <div id="chat-card" class="card">
                    <h3>Tahminler ve Sohbet</h3>
                    <ul id="messages"></ul>
                    <form id="chat-form" class="chat-form-container">
                        <input id="chat-input" autocomplete="off" placeholder="Tahmininizi Yazın..." />
                        <button>Gönder</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- HTML ELEMENTLERİ VE DEĞİŞKENLER ---
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const nicknameInput = document.getElementById('nickname-input');
        const roomList = document.getElementById('room-list');
        const newRoomInput = document.getElementById('new-room-input');
        const createRoomButton = document.getElementById('create-room-button');

        const timerDisplay = document.getElementById('timer'); // Yeni
        const drawerInfo = document.getElementById('drawer-info');
        const wordInfo = document.getElementById('word-info');
        const wordInfoDrawer = document.getElementById('word-info-drawer');
        const controls = document.getElementById('controls');
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');
        const messages = document.getElementById('messages');
        const canvas = document.getElementById('game-container');
        const leaderboardList = document.getElementById('leaderboard-list'); // Yeni
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('color-picker');
        const brushSize = document.getElementById('brush-size');
        
        let socket = null;
        let isDrawing = false;
        let isDrawer = false; 
        let lastX = 0;
        let lastY = 0;
        
        ctx.lineCap = 'round';
        
        socket = io();
        initializeGame(socket); 

        // --- LOBİ MANTIĞI ---

        socket.on('lobby update', (lobbyData) => {
            roomList.innerHTML = '';
            let hasRooms = false;
            
            for (const roomName in lobbyData) {
                hasRooms = true;
                const data = lobbyData[roomName];
                const li = document.createElement('li');
                li.className = 'room-item';
                
                const isFull = data.playerCount >= data.maxPlayers;
                
                li.innerHTML = `
                    <div class="room-info">
                        <strong>${roomName}</strong> 
                    </div>
                    <div class="room-status">
                        <p style="margin: 5px 0;">Çizen: ${data.drawer}</p>
                        <p style="margin: 5px 0; font-weight: bold;">${data.playerCount}/${data.maxPlayers} kişi</p>
                    </div>
                `;
                
                const joinButton = document.createElement('button');
                joinButton.textContent = isFull ? 'Dolu' : 'Katıl';
                joinButton.disabled = isFull;
                
                if (isFull) {
                    joinButton.style.backgroundColor = '#dc3545';
                } else {
                    joinButton.style.backgroundColor = '#28a745'; 
                    joinButton.addEventListener('click', () => joinRoom(roomName));
                }
                
                li.appendChild(joinButton);
                roomList.appendChild(li);
            }
            
            if (!hasRooms) {
                roomList.innerHTML = '<li style="text-align: center; color: #6c757d; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 5px;">Şu anda aktif oda yok. Yeni bir oda oluşturun!</li>';
            }
        });

        createRoomButton.addEventListener('click', () => {
            const roomName = newRoomInput.value.trim();
            if (roomName) {
                joinRoom(roomName);
            } else {
                alert("Lütfen bir oda adı girin.");
            }
        });

        function joinRoom(roomName) {
            const nickname = nicknameInput.value.trim();
            if (!nickname) {
                alert("Lütfen önce kullanıcı adınızı girin.");
                return;
            }
            
            socket.emit('join room', { nickname: nickname, room: roomName });
        }
        
        socket.on('joined', (roomName) => {
            lobbyView.style.display = 'none';
            gameView.style.display = 'flex';
            document.title = `Gartic Klonu - Oda: ${roomName}`;
            chatInput.disabled = false;
            chatForm.querySelector('button').disabled = false;
        });

        socket.on('join error', (message) => {
            alert(`Hata: ${message}`);
        });

        // --- OYUN MANTIĞI ---

        function initializeGame(socket) { 
            // Çizim fonksiyonları (Değişmedi)
            function drawLine(x0, y0, x1, y1, color, size) {
                ctx.strokeStyle = color;
                ctx.lineWidth = size;
                ctx.beginPath();
                ctx.moveTo(x0, y0);
                ctx.lineTo(x1, y1);
                ctx.stroke();
            }

            function startDrawing(e) {
                if (!isDrawer) return; 
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }

            function draw(e) {
                if (!isDrawing) return; 
                const currentX = e.offsetX;
                const currentY = e.offsetY;
                const color = colorPicker.value;
                const size = brushSize.value;

                drawLine(lastX, lastY, currentX, currentY, color, size);
                
                const data = { x0: lastX, y0: lastY, x1: currentX, y1: currentY, color: color, size: size };
                socket.emit('draw', data);
                [lastX, lastY] = [currentX, currentY];
            }
            
            function stopDrawing() { isDrawing = false; }

            window.requestClearCanvas = function() {
                if (isDrawer) { socket.emit('clear canvas'); }
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            colorPicker.addEventListener('input', (e) => { ctx.strokeStyle = e.target.value; });
            brushSize.addEventListener('input', (e) => { ctx.lineWidth = e.target.value; });

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (chatInput.value.trim()) {
                    socket.emit('chat message', chatInput.value); 
                    chatInput.value = '';
                }
            });
            
            // --- SOCKET.IO OLAYLARI (Zamanlayıcı, Puan Tablosu ve Oyun Alanı) ---
            
            socket.on('timer update', (seconds) => {
                timerDisplay.textContent = seconds < 10 ? `0${seconds}` : seconds;
                // Zaman daraldıkça rengi değiştir (İsteğe bağlı)
                if (seconds <= 10) {
                     timerDisplay.style.color = 'red';
                     timerDisplay.style.borderColor = 'red';
                } else {
                     timerDisplay.style.color = '#dc3545';
                     timerDisplay.style.borderColor = '#dc3545';
                }
            });

            socket.on('leaderboard update', (leaderboard) => {
                leaderboardList.innerHTML = '';
                if (leaderboard.length === 0) {
                    leaderboardList.innerHTML = '<li style="color: #6c757d;">Oyuncular bekleniyor...</li>';
                    return;
                }
                
                leaderboard.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item';
                    li.innerHTML = `
                        <span>${index + 1}. ${player.nickname}</span>
                        <strong>${player.score}</strong>
                    `;
                    leaderboardList.appendChild(li);
                });
            });

            socket.on('draw', (data) => { drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.size); });
            socket.on('clear canvas', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); });
            
            socket.on('drawing history', (history) => {
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                history.forEach(data => { drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.size); });
            });

            socket.on('game state', (state) => {
                drawerInfo.textContent = state.drawer;
                wordInfo.textContent = state.wordLength ? '_ '.repeat(state.wordLength) : 'Bekleniyor...';
            });
            
            socket.on('draw state', (state) => {
                isDrawer = state.isDrawer;

                if (isDrawer) {
                    wordInfoDrawer.textContent = `(Kelime: ${state.word})`;
                    wordInfoDrawer.style.display = 'inline';
                    
                    controls.style.display = 'flex';
                    chatInput.placeholder = 'Çizen tahmin edemez.';
                    chatInput.disabled = true;
                    chatForm.querySelector('button').disabled = true;
                } else {
                    wordInfoDrawer.style.display = 'none';
                    wordInfoDrawer.textContent = '';
                    
                    controls.style.display = 'none';
                    chatInput.placeholder = 'Tahmininizi Yazın...';
                    chatInput.disabled = false;
                    chatForm.querySelector('button').disabled = false;
                }
            });

            socket.on('chat message', (msg) => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="font-weight: bold;">${msg.split(':')[0]}:</span> ${msg.split(':')[1]}`;
                messages.appendChild(li);
                messages.scrollTop = messages.scrollHeight; 
            });

            socket.on('system message', (msg) => {
                const li = document.createElement('li');
                li.className = 'system-message';
                li.textContent = `[Sistem] ${msg}`;
                messages.appendChild(li);
                messages.scrollTop = messages.scrollHeight; 
            });
        }
    </script>
</body>
</html>